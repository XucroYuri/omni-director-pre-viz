---
status: ARCHIVED
---

# 架构审查与预重构审计报告 (Pre-Refactor Audit)

> 历史文档说明：本报告为分支阶段审计快照，当前实施入口为 `rules.md` 与 `docs/*`。

**状态**：待评审 (Pending Review)
**基准文档**：`dev/Plan-Codex.md`, `rules.md`
**目标**：识别当前实现与目标架构（Codex 版）的差距，锁定 Phase 8/9 的重构重点。

---

## 1. 核心差距总结 (Executive Summary)

当前项目已完成“桌面化”改造，实现了 Electron 主进程承载 AI 调用，但在**业务逻辑深度**（缺少分层）、**生产稳定性**（队列不可靠）以及**交付规范**（命名与对账缺失）方面，仍处于“原型级”实现，尚未达到 `Plan-Codex` 的生产标准。

---

## 2. 深度审计详情

### 2.1 业务分层：剧本解析深度不足 (P0)
*   **现状**：剧本拆解（`breakdownScript`）直接产出 `shots` 列表。
*   **偏差**：缺失 **Episode → Scene → Beat → Shot** 的行业标准层级。
*   **风险**：
    *   **剧情压缩**：长文本直接拆 Shot 会导致 LLM 严重遗漏细节（如眼神、小动作）。
    *   **上下文丢失**：Shot 无法感知所属的 Scene/Beat，导致资产绑定（如场景光效）缺乏继承性。
*   **对标要求**：必须先切分 Scene（粗），再切分 Beat（细，建议 15-30 个），最后在 Beat 内产出 Shot。

### 2.2 任务治理：伪队列与持久化缺失 (P0)
*   **现状**：`ipcRenderer` 直接触发 `generateGridImage`，虽然通过 `p-limit` 做了内存限流，但不是真正的任务系统。
*   **缺陷**：
    *   **重启即失**：排队中的任务或执行中的任务在软件关闭/崩溃后无法恢复。
    *   **状态盲区**：前端无法精确展示“排队中（第 N 位）”、“重试中（第 M 次）”等状态。
*   **对标要求**：必须将任务提交给 `TaskQueue`（持久化在 SQLite），由后端 Worker 异步执行并回写状态。

### 2.3 交付规范：命名与对账闭环缺失 (P1)
*   **现状**：
    *   图片命名混杂（使用 Hash），不符合 Episode/Scene/Shot 的可读性规范。
    *   生成物（母图/切片/视频）之间缺乏逻辑关联。
*   **缺失组件**：
    *   **manifest.json**：每个生成版本必须包含对账单，记录 Prompt、Model、Provider、资产绑定、时间戳等审计信息。
    *   **ZIP 打包器**：目前仅支持单图下载，缺乏整集打包交付能力。
*   **对标要求**：生成物必须聚合在 `output/` 目录，且每个 Grid 版本自带 Manifest。

### 2.4 资产一致性：强校验尚未锁定 (P1)
*   **现状**：UI 虽有资产库，但在生成母图前，系统并未强制校验“角色绑定”与“场景绑定”。
*   **缺陷**：允许空载生成会导致“角色跑偏”，浪费 API 配额。
*   **对标要求**：`GenerationPolicy` 必须作为硬门禁，未绑定（且非 ENV 镜头）时应阻断生成按钮。

---

## 3. 建议重构路线图 (Phase 8/9 Focus)

### 第一阶段：后端权威化 (Back-end Empowerment)
1.  **分层拆解**：修改 `aihubmix/gemini.ts`，引入两段式拆解（Scene -> Beat -> Shot）。
2.  **真队列落地**：将 IPC 调用从“同步等待执行”改为“提交任务 ID”，前端通过订阅/轮询任务表更新 UI。

### 第二阶段：存储与交付规范化 (Delivery Standards)
1.  **路径标准化**：建立 `output/{EpisodeID}/shots/{ShotID}/` 树状结构。
2.  **Manifest 自动生成**：在母图生成任务完成后，立即在同级目录写入 `manifest.json`。

### 第三阶段：一致性闭环 (Consistency Loop)
1.  **资产注入升级**：完善 Prompt 组装逻辑，确保角色参考图的语义说明（Ref Semantics）能准确传达给模型。

---

## 4. 关键待办 (Critical To-Do)

- [ ] 确认是否在下一次重构中立即引入 `Scene/Beat` 数据库表结构。
- [ ] 确认 `sora-2` 视频生成的参数映射逻辑（是否固定 16:9/9:16）。
- [ ] 审查 `output/` 目录的自动清理逻辑（当前默认暂不自动删除）。
